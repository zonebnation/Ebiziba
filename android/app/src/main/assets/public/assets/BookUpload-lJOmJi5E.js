import{j as e,m as r}from"./framer--EiQgGdQ.js";import{r as a}from"./vendor-fbM9bkeS.js";import{u as t,X as s,L as l,s as o,I as n}from"./index-CGXY-R5d.js";import{U as d}from"./upload-lX1edj6g.js";import"./utils-DiRS1ToC.js";import"./supabase-DkUcngs9.js";import"./ui-Yji1MIDK.js";const i=({onSuccess:i,onCancel:c})=>{const{user:u}=t(),[g,b]=a.useState(""),[x,m]=a.useState(""),[p,y]=a.useState(""),[h,f]=a.useState(""),[j,k]=a.useState("Luganda"),[v,N]=a.useState(null),[w,C]=a.useState(null),[S,P]=a.useState(!1),[z,E]=a.useState(null),[F,$]=a.useState(0),[U,I]=a.useState(!0),M=a.useRef(null),L=a.useRef(null),A=async(e,r)=>{const a=e.name.split(".").pop(),t=`${Math.random().toString(36).slice(2)}.${a}`,s=`${null==u?void 0:u.id}/${t}`,{data:l,error:n}=await o.storage.from(r).upload(s,e,{upsert:!0,onUploadProgress:e=>{const r=e.loaded/e.total*100;$(r)}});if(n)throw n;const{data:{publicUrl:d}}=o.storage.from(r).getPublicUrl(s);return d};return e.jsx(r.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md overflow-hidden",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Add New Book"}),e.jsx("button",{onClick:c,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors",children:e.jsx(s,{size:20,className:"text-gray-500 dark:text-gray-400"})})]}),z&&e.jsx("div",{className:"mb-4 p-4 bg-red-50 dark:bg-red-900/20 text-red-500 rounded-lg text-sm",children:z}),e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),u)if(v&&w&&g.trim()&&p.trim()&&h.trim())try{P(!0),E(null);const e=await A(v,"covers"),{data:a,error:t}=await o.from("books").insert({title:g,description:p,author:x,language:j,digital_price:parseInt(h),cover_url:e,content_url:"pending"}).select().single();if(t)throw t;if(!a)throw new Error("No data returned from book creation");let s;if(U)try{s=await(async(e,r)=>{try{$(0);const a=new FileReader,t=await new Promise(((r,t)=>{a.onload=()=>{"string"==typeof a.result?r(a.result):t(new Error("Failed to read file as text"))},a.onerror=t,"application/pdf"===e.type?a.readAsDataURL(e):a.readAsText(e),a.onprogress=e=>{if(e.lengthComputable){const r=e.loaded/e.total*50;$(r)}}})),s=n.getInstance();let l;return l=e.size>1048576?await s.uploadLargeContent(t,`${g} (${r})`,"book",1048576):await s.uploadContent(t,`${g} (${r})`,"book",e.type),$(100),`ipfs://${l}`}catch(a){throw console.error("Error uploading to IPFS:",a),a}})(w,a.id)}catch(r){console.error("IPFS upload failed, falling back to Supabase Storage:",r),s=await A(w,"books")}else s=await A(w,"books");const{error:l}=await o.from("books").update({content_url:s}).eq("id",a.id);if(l)throw l;b(""),m(""),y(""),f(""),N(null),C(null),$(0),null==i||i()}catch(a){console.error("Error uploading book:",a),E("Failed to upload book. Please try again.")}finally{P(!1)}else E("Please fill in all required fields");else E("Please sign in to upload books")},className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Title"}),e.jsx("input",{type:"text",value:g,onChange:e=>b(e.target.value),className:"w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:border-primary-500 dark:focus:border-primary-500 bg-white dark:bg-gray-800",placeholder:"Enter book title",disabled:S})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Author"}),e.jsx("input",{type:"text",value:x,onChange:e=>m(e.target.value),className:"w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:border-primary-500 dark:focus:border-primary-500 bg-white dark:bg-gray-800",placeholder:"Enter author name",disabled:S})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Description"}),e.jsx("textarea",{value:p,onChange:e=>y(e.target.value),className:"w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:border-primary-500 dark:focus:border-primary-500 bg-white dark:bg-gray-800",placeholder:"Enter book description",rows:3,disabled:S})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Price (UGX)"}),e.jsx("input",{type:"number",value:h,onChange:e=>f(e.target.value),className:"w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:border-primary-500 dark:focus:border-primary-500 bg-white dark:bg-gray-800",placeholder:"Enter price",disabled:S})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Language"}),e.jsxs("select",{value:j,onChange:e=>k(e.target.value),className:"w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:border-primary-500 dark:focus:border-primary-500 bg-white dark:bg-gray-800",disabled:S,children:[e.jsx("option",{value:"Luganda",children:"Luganda"}),e.jsx("option",{value:"English",children:"English"}),e.jsx("option",{value:"Arabic",children:"Arabic"})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Use IPFS for content storage"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Reduces app size by storing content on IPFS"})]}),e.jsx("button",{type:"button",onClick:()=>I(!U),className:"relative w-12 h-6 rounded-full transition-colors "+(U?"bg-primary-500":"bg-gray-300 dark:bg-gray-600"),children:e.jsx("span",{className:"absolute top-1 left-1 w-4 h-4 rounded-full bg-white transition-transform "+(U?"translate-x-6":"")})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("input",{type:"file",ref:M,onChange:e=>{var r;const a=null==(r=e.target.files)?void 0:r[0];a&&(a.type.startsWith("image/")?a.size>2097152?E("Cover image size must be less than 2MB"):(N(a),E(null)):E("Please select a valid image file for cover"))},accept:"image/*",className:"hidden",disabled:S}),e.jsxs("button",{type:"button",onClick:()=>{var e;return null==(e=M.current)?void 0:e.click()},className:"w-full p-4 border-2 border-dashed rounded-lg flex flex-col items-center justify-center space-y-2 "+(v?"border-green-500 bg-green-50 dark:bg-green-900/20":"border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700"),disabled:S,children:[e.jsx(d,{size:24,className:v?"text-green-500":"text-gray-400"}),e.jsx("div",{className:"text-sm text-center",children:v?e.jsx("span",{className:"text-green-500",children:v.name}):e.jsxs("span",{className:"text-gray-500 dark:text-gray-400",children:["Click to upload cover image",e.jsx("br",{}),e.jsx("span",{className:"text-xs",children:"JPG, PNG or GIF (Max 2MB)"})]})})]})]}),e.jsxs("div",{children:[e.jsx("input",{type:"file",ref:L,onChange:e=>{var r;const a=null==(r=e.target.files)?void 0:r[0];a&&("application/pdf"===a.type?a.size>52428800?E("Content file size must be less than 50MB"):(C(a),E(null)):E("Please select a PDF file for content"))},accept:".pdf",className:"hidden",disabled:S}),e.jsxs("button",{type:"button",onClick:()=>{var e;return null==(e=L.current)?void 0:e.click()},className:"w-full p-4 border-2 border-dashed rounded-lg flex flex-col items-center justify-center space-y-2 "+(w?"border-green-500 bg-green-50 dark:bg-green-900/20":"border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700"),disabled:S,children:[e.jsx(d,{size:24,className:w?"text-green-500":"text-gray-400"}),e.jsx("div",{className:"text-sm text-center",children:w?e.jsx("span",{className:"text-green-500",children:w.name}):e.jsxs("span",{className:"text-gray-500 dark:text-gray-400",children:["Click to upload book content",e.jsx("br",{}),e.jsx("span",{className:"text-xs",children:"PDF only (Max 50MB)"})]})})]})]})]}),S&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-2 bg-gray-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-primary-500 transition-all duration-300",style:{width:`${F}%`}})}),e.jsxs("p",{className:"text-sm text-center text-gray-500 dark:text-gray-400",children:["Uploading... ",Math.round(F),"%"]})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{type:"button",onClick:c,className:"flex-1 px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors",disabled:S,children:"Cancel"}),e.jsx("button",{type:"submit",disabled:S||!v||!w,className:"flex-1 px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center",children:S?e.jsx(l,{className:"w-5 h-5 animate-spin"}):"Upload"})]})]})]})})})};export{i as BookUpload};
